<!doctype html>
<html lang="pt">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>LOCAlbum - Offline Photo Album</title>
<style>
:root{ --bg:#0f1115; --card:#0b0d10; --muted:#9aa0a6; --accent:#9ab; }

html,body{
  height:100%; margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial;
  color:#eee; background:var(--bg); transition:background .3s; overflow:hidden;
}

.container{
  max-width:1200px; margin:16px auto; padding:14px 18px;
  height:calc(100% - 32px); box-sizing:border-box;
  display:flex; flex-direction:column;
}

/* --- TransiÃ§Ã£o suave entre fotos --- */
.stage img,
.stage video {
  position: absolute;
  inset: 0;
  margin: auto;
  max-width: 100%;
  max-height: 100%;
  width: auto;
  height: auto;
  object-fit: contain;
  border-radius: 6px;
  opacity: 0;
  transition: opacity 0.6s ease;
}

.stage img.visible,
.stage video.visible {
  opacity: 1;
}

/* ---------- Header / TÃ­tulo + Controlo ---------- */
header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-wrap: nowrap;          /* ğŸ‘ˆ impede que o tÃ­tulo salte de linha */
  gap: 10px;
  margin-top: -28px;
  margin-bottom: -4px;
  overflow: hidden;           /* ğŸ‘ˆ necessÃ¡rio para o ellipsis funcionar */
}
.controls {
  flex: 0 0 auto;          /* mantÃ©m largura natural, sem encolher */
  min-width: 320px;        /* ğŸ‘ˆ ajusta se quiseres mais ou menos espaÃ§o */
}

header h1{margin:-28px 0 0 0;font-size:30px;letter-spacing:0.4px}

.titulo-brilhante {
  font-size: 42px;
  letter-spacing: 0.4px;
  line-height: 1.1;
  display: block;               /* ğŸ‘ˆ de inline-block â†’ block, permite truncar */
  padding-bottom: 2px;
  background: linear-gradient(90deg, #fff, #ffd6e8, #fff);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-size: 200% auto;
  animation: brilhoSuave 6s linear infinite;
  text-shadow: 0 0 8px rgba(255,182,217,.15);
  overflow: hidden;             /* ğŸ‘ˆ ajuda o ellipsis */
  text-overflow: ellipsis;      /* ğŸ‘ˆ ativa o corte */
  white-space: nowrap;          /* ğŸ‘ˆ mantÃ©m tudo numa linha */
  max-width: 100%;              /* ğŸ‘ˆ respeita o espaÃ§o disponÃ­vel */
}


/* --- Truncamento automÃ¡tico e adaptativo do tÃ­tulo --- */
header > div:first-child {
  flex: 1 1 auto;
  min-width: 0;
}

header h1#headline {
  flex: 1 1 auto;
  min-width: 0;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  cursor: help;
  display: block;           /* ğŸ‘ˆ ForÃ§a comportamento de bloco dentro do flex */
  max-width: 100%;          /* garante que respeita a caixa flex */
}


@keyframes brilhoSuave{0%{background-position:200% center}100%{background-position:-200% center}}

/* ========================= */
/* REMOVER SUBTÃTULO         */
/* ========================= */
#subtitle { display: none !important; }

/* Painel de controlos Ã  direita (3 linhas) */
.controls{
  display:flex; flex-direction:column; align-items:flex-end; gap:6px; margin-left:auto; text-align:right;
  background:rgba(255,255,255,0.03); padding:8px 10px; border-radius:10px; backdrop-filter:blur(6px)
}
.controls-row{display:flex;flex-wrap:wrap;gap:8px;justify-content:flex-end;align-items:center}
.controls-row+.controls-row{margin-top:4px}
button{
  background:transparent; border:1px solid rgba(255,255,255,.12);
  padding:8px 12px; border-radius:10px; color:#fff; cursor:pointer; transition:.15s
}
button:hover{background:rgba(255,255,255,.06)}
button.active{background:var(--accent); color:#071018; font-weight:700}
.select{background:rgba(0,0,0,.45);border:1px solid rgba(255,255,255,.2);color:#fff;border-radius:8px;padding:6px}
#langToggle{user-select:none;display:flex;align-items:center;gap:4px;font-size:20px}

/* ---------- Barra de filtros (sempre texto branco) ---------- */
#filterBar{
  display:flex;
  gap:8px;
  margin:-26px 0 4px 0; /* como pediste */
  align-items:center;
}
#filterBar button{
  display:inline-flex; align-items:center; gap:6px; color:#fff;  /* texto sempre branco */
}
#filterBar button.active{ background:rgba(255,255,255,.18) }
#filterBar button:hover{  background:rgba(255,255,255,.10) }

/* ---------- NavegaÃ§Ã£o por ano/mÃªs ---------- */
nav#years{
  display:flex;
  flex-wrap:nowrap;      /* impede saltar linha */
  overflow-x:auto;       /* permite scroll horizontal */
  gap:8px;
  padding-bottom:6px;
  scrollbar-width: thin; /* Firefox */
}
nav#years::-webkit-scrollbar{
  height:6px;
}
nav#years::-webkit-scrollbar-thumb{
  background:rgba(255,255,255,.2);
  border-radius:4px;
}
nav#years{
  margin-top:0px;       /* como pediste */
  margin-bottom:4px;
}
nav#months{
  margin-top:0px;       /* como pediste */
  margin-bottom:4px;
}

/* ---------- Ãrea principal ---------- */
main.viewer{
  flex:1; background:var(--card); border-radius:12px; padding:12px;
  display:grid; grid-template-columns:1fr 360px; gap:12px;
  position:relative; transition:background .3s; overflow:hidden
}
.stage{
  width:100%; height:100%; border-radius:8px; display:flex; align-items:center; justify-content:center;
  position:relative; overflow:hidden; background:linear-gradient(180deg,rgba(0,0,0,.06),rgba(0,0,0,.02))
}
/* âœ… Sem corte: usa auto + mÃ¡ximos */
.stage img,.stage video{
  max-width:100%; max-height:100%; width:auto; height:auto;
  object-fit:contain; display:block; border-radius:6px; opacity:0; transition:opacity .6s ease
}
.stage img.visible,.stage video.visible{opacity:1}

.meta{position:absolute;left:12px;bottom:12px;background:rgba(0,0,0,.45);padding:6px 10px;border-radius:8px;font-size:13px;color:var(--muted);z-index:1001}
.age{position:absolute;right:12px;bottom:12px;background:rgba(0,0,0,.45);padding:6px 10px;border-radius:8px;font-size:13px;color:#ffd;z-index:1001}
.counter{position:absolute;left:12px;top:12px;background:rgba(0,0,0,.45);padding:6px 10px;border-radius:8px;font-size:13px;color:#fff;z-index:1001;display:none}
.progress{position:absolute;left:0;top:0;height:3px;width:0;background:var(--accent);z-index:1002;transition:width linear}

/* Thumbs + data visÃ­vel */
.thumbs {
  position: relative;
  height: 100%;
  overflow-y: auto;              /* ğŸ‘ˆ apenas scroll vertical */
  overflow-x: hidden;            /* ğŸ‘ˆ impede scroll lateral */
  padding: 6px;
  border-left: 1px solid rgba(255,255,255,.06);
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.thumb{display:flex;gap:10px;align-items:center;padding:6px;border-radius:8px;cursor:pointer;position:relative}
.thumb:hover{background:rgba(255,255,255,.06)}
.thumb.active{background:rgba(255,255,255,.12)}
.thumb img,.thumb video{width:96px;height:68px;object-fit:cover;border-radius:6px;flex:0 0 auto}
.thumb .date{font-size:12px;color:var(--muted);white-space:nowrap}
.videoIcon{position:absolute;left:6px;bottom:6px;font-size:18px;color:#fff;text-shadow:0 0 4px #000;background:rgba(0,0,0,.4);border-radius:4px;padding:2px 4px;pointer-events:none}

.footer{margin-top:8px;color:var(--muted);font-size:13px;text-align:center}

/* ---------- Fullscreen: esconder UI (filtros, anos/meses, thumbs) ---------- */
:fullscreen header,
:fullscreen #filterBar,
:fullscreen nav#years,
:fullscreen nav#months,
:fullscreen .thumbs{ display:none!important }
:fullscreen main.viewer{ grid-template-columns:1fr }

/* ---------- HUD Fullscreen (aparece ao mexer o rato) ---------- */
.fsHud{
  position:fixed; right:12px; bottom:12px; display:none; gap:8px; z-index:2147483646; align-items:center;
  background:rgba(0,0,0,.45); border:1px solid rgba(255,255,255,.2); padding:8px 10px; border-radius:10px;
  opacity:0; transition:opacity .25s;
}
.fsHud.show{ opacity:1; }

/* ---------- Setas laterais ---------- */
.arrow{position:fixed;top:50%;transform:translateY(-50%);font-size:42px;font-weight:400;color:rgba(255,255,255,.8);
  background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.12);width:56px;height:56px;border-radius:50%;
  display:flex;align-items:center;justify-content:center;cursor:pointer;z-index:2147483647;transition:all .25s ease;
  box-shadow:0 0 10px rgba(0,0,0,.4);opacity:0;pointer-events:none}
.arrow:hover{background:rgba(255,255,255,.15);transform:translateY(-50%) scale(1.1);color:#fff}
.arrow.left{left:28px}.arrow.right{right:28px}
:fullscreen .arrow{display:flex;opacity:1;pointer-events:auto}
body.show-arrows .arrow{opacity:1;pointer-events:auto}

/* ---------- Responsivo ---------- */
@media(max-width:900px){
  main.viewer{grid-template-columns:1fr}
  .thumbs{order:2;border-left:none;border-top:1px solid rgba(255,255,255,.06);height:160px;display:flex;overflow-x:auto;flex-direction:row}
}

/* --- Separador visÃ­vel entre dias --- */
.thumbs {
  position: relative;
}

.day-separator {
  position: relative;
  width: 100%;
  height: 0;
  margin: 1px 0;
}

.day-separator::after {
  content: "";
  position: absolute;
  left: 0;
  right: 0;
  top: 0;
  height: 1px;
  background: linear-gradient(
    90deg,
    transparent 0%,
    color-mix(in srgb, var(--accent) 75%, transparent) 15%,
    color-mix(in srgb, var(--accent) 75%, transparent) 85%,
    transparent 100%
  );
  opacity: clamp(0.4, calc(0.8 - (var(--bg-luminance, 0.2) * 0.5)), 0.85);
  pointer-events: none;
  border-radius: 1px;
  transition: opacity 0.3s ease;
}


</style>
</head>
<body>
<div class="container">
  <header>
    <div>
      <h1 id="headline" class="titulo-brilhante">MemÃ³rias</h1>
      <div id="subtitle"></div>
    </div>

    <div class="controls">
      <!-- linha 1 -->
      <div class="controls-row">
        <button id="fullscreen">Fullscreen (F)</button>
        <button id="slideshow">Iniciar slideshow (space)</button>
        <label style="display:flex;align-items:center;gap:6px">
          <span id="speedLbl">Velocidade</span>
          <select id="speed" class="select">
            <option value="2000">2s</option>
            <option value="4000" selected>4s</option>
            <option value="8000">8s</option>
            <option value="15000">15s</option>
          </select>
        </label>
      </div>
      <!-- linha 2 -->
      <div class="controls-row">
        <label style="display:flex;align-items:center;gap:6px">
          <span id="themeLbl">Tema</span>
          <select id="theme" class="select">
            <option value="dark">Escuro</option>
            <option value="pink">Rosa</option>
            <option value="sky">Azul CÃ©u</option>
            <option value="lavender">Lavanda</option>
            <option value="ocean">Oceano</option>
            <option value="sunset">PÃ´r-do-sol</option>
            <option value="gold">Dourado</option>
            <option value="lilac">LilÃ¡s</option>
            <option value="peach">PÃªssego</option>
            <option value="neon">Neon Preto</option>
          </select>
        </label>
        <label style="display:flex;align-items:center;gap:6px">
          <span id="gradLbl">Gradiente</span>
          <select id="grad" class="select">
            <option value="pink">Rosa / Pink</option>
            <option value="blue">Azul / Blue</option>
            <option value="gold">Dourado / Gold</option>
            <option value="lilac">LilÃ¡s / Lilac</option>
            <option value="aqua">Verde-Ãgua / Aqua</option>
            <option value="ruby">Rubi / Ruby</option>
            <option value="emerald">Esmeralda / Emerald</option>
            <option value="sunrise">Nascer do Sol / Sunrise</option>
            <option value="neon">Neon Verde / Neon</option>
            <option value="silver">Prateado / Silver</option>
          </select>
        </label>
      </div>
      <!-- linha 3 -->
      <div class="controls-row">
        <div id="langToggle" style="cursor:pointer;font-size:20px;line-height:1.2">ğŸ‡µğŸ‡¹ / ğŸ‡¬ğŸ‡§</div>
        <button id="saveTheme" title="Guardar todas as preferÃªncias">ğŸ’¾</button>
      </div>
    </div>
  </header>

  <!-- Filtros ficam acima dos anos (mais espaÃ§o para a foto) -->
  <div id="filterBar">
    <button id="fltAll"   class="active">ğŸ“ Tudo</button>
    <button id="fltPhotos">ğŸ“· Fotos</button>
    <button id="fltVideos">ğŸ¬ VÃ­deos</button>
  </div>

  <nav id="years"></nav>
  <nav id="months"></nav>

  <main class="viewer">
    <section class="stage" id="stage">
      <div id="ph" style="color:var(--muted)">ğŸ‘‹ Escolhe um ano e mÃªs para comeÃ§ar.</div>
      <div class="progress" id="bar"></div>
      <div class="counter" id="counter"></div>
      <div class="meta" id="meta" style="display:none"></div>
      <div class="age" id="age" style="display:none"></div>
    </section>
    <aside class="thumbs" id="thumbs"></aside>
  </main>

  <div class="footer" id="footerLine"></div>
</div>

<!-- HUD do fullscreen (sÃ³ quando em F11) -->
<div class="fsHud" id="fsHud">
  <button id="fsToggle">Iniciar slideshow</button>
  <label style="display:flex;align-items:center;gap:6px">
    <span id="fsSpeedLbl">Velocidade</span>
    <select id="fsSpeed" class="select">
      <option value="2000">2s</option>
      <option value="4000" selected>4s</option>
      <option value="8000">8s</option>
      <option value="15000">15s</option>
    </select>
  </label>
  <button id="fsExit">Sair</button>
</div>

<!-- Setas -->
<div class="arrow left"  id="arrowLeft">â€¹</div>
<div class="arrow right" id="arrowRight">â€º</div>

<script>
/* Estas duas linhas sÃ£o substituÃ­das pelo z1.ps1 */
<!--CONFIG-->
<!--MANIFEST-->

// ===== I18N =====
const STR = {
  pt:{
    choose:"ğŸ‘‹ Escolhe um ano e mÃªs para comeÃ§ar.",
    speed:"Velocidade",
    theme:"Tema",
    gradient:"Gradiente",
    start:"Iniciar slideshow (space)",
    stop:"Parar slideshow (space)",
    exit:"Sair",
    fullscreen:"Fullscreen (F)",
    all:"ğŸ“ Tudo",
    photos:"ğŸ“· Fotos",
    videos:"ğŸ¬ VÃ­deos",
    by:"Feito por",
    donate:"DoaÃ§Ãµes",
    project:"Projeto"
  },
  en:{
    choose:"ğŸ‘‹ Pick a year and month to begin.",
    speed:"Speed",
    theme:"Theme",
    gradient:"Gradient",
    start:"Start slideshow (space)",
    stop:"Stop slideshow (space)",
    exit:"Exit",
    fullscreen:"Fullscreen (F)",
    all:"ğŸ“ All",
    photos:"ğŸ“· Photos",
    videos:"ğŸ¬ Videos",
    by:"Made by",
    donate:"Donations",
    project:"Project"
  }
};

document.title = (typeof CONFIG!=='undefined' && CONFIG.pageTitle) ? CONFIG.pageTitle : "Offline Photo Album";
const BIRTHDATE = (typeof CONFIG!=='undefined' && CONFIG.birthdate ? CONFIG.birthdate : "").trim();

// ===== Themes =====
const themes = {
  dark:{bg:"#0f1115",card:"#0b0d10",muted:"#9aa0a6",accent:"#9ab"},
  pink:{bg:"#1a0b12",card:"#2a0f1c",muted:"#f7a7c0",accent:"#ffb6d9"},
  sky :{bg:"#0d1b24",card:"#132634",muted:"#a3d0f4",accent:"#6cf"},
  lavender:{bg:"#1a1423",card:"#261b33",muted:"#d8c7ff",accent:"#b28dff"},
  ocean   :{bg:"#082026",card:"#0d323a",muted:"#8ad3e4",accent:"#4ec2d6"},
  sunset  :{bg:"#2b0e12",card:"#3d1418",muted:"#ffb8a8",accent:"#ff7e5f"},
  gold    :{bg:"#1d1505",card:"#3a2a0a",muted:"#ffeb99",accent:"#ffcc33"},
  lilac   :{bg:"#201425",card:"#301a38",muted:"#e5c9ff",accent:"#c48bff"},
  peach   :{bg:"#2b1a15",card:"#3e241c",muted:"#ffd3b6",accent:"#ffab86"},
  neon    :{bg:"#000000",card:"#0a0a0a",muted:"#8e8e8e",accent:"#39ff14"}
};

const yearsEl = document.getElementById('years');
const monthsEl= document.getElementById('months');
const thumbsEl= document.getElementById('thumbs');
const stage   = document.getElementById('stage');
const metaEl  = document.getElementById('meta');
const ageEl   = document.getElementById('age');
const bar     = document.getElementById('bar');
const counterEl = document.getElementById('counter');
const ph      = document.getElementById('ph');

const speedSel= document.getElementById('speed');
const fsSpeed = document.getElementById('fsSpeed');
const fsHud   = document.getElementById('fsHud');
const fsToggle= document.getElementById('fsToggle');
const themeSel= document.getElementById('theme');
const saveTheme= document.getElementById('saveTheme');
const grad    = document.getElementById('grad');
const langToggle=document.getElementById('langToggle');

const fltAll=document.getElementById('fltAll');
const fltPhotos=document.getElementById('fltPhotos');
const fltVideos=document.getElementById('fltVideos');

let flatList = [], curIdx = 0, timer = null, slideMs = +speedSel.value;
let currentYear=null, currentMonth=null;
let Lang = localStorage.getItem('album_lang') || (typeof CONFIG!=='undefined' ? (CONFIG.language||'pt') : 'pt');

/* Helpers */
function applyTheme(name){
  const t = themes[name] || themes.dark;
  for(const k in t) document.documentElement.style.setProperty(`--${k}`, t[k]);
  themeSel.value = name;
}
function saveThemePref(){ localStorage.setItem('album_theme', themeSel.value); }

/* Gradiente do tÃ­tulo */
function applyGradient(name){
  const headline=document.querySelector('.titulo-brilhante');
  const map={
    pink:'linear-gradient(90deg,#fff,#ffd6e8,#fff)',
    blue:'linear-gradient(90deg,#fff,#aee3ff,#fff)',
    gold:'linear-gradient(90deg,#fff8dc,#ffd700,#fff8dc)',
    lilac:'linear-gradient(90deg,#fff,#d6c2ff,#fff)',
    aqua:'linear-gradient(90deg,#fff,#a9fff7,#fff)',
    ruby:'linear-gradient(90deg,#fff,#ff8a8a,#fff)',
    emerald:'linear-gradient(90deg,#fff,#9dffcf,#fff)',
    sunrise:'linear-gradient(90deg,#fff,#ffb48a,#fff)',
    neon:'linear-gradient(90deg,#fff,#b7ff8f,#fff)',
    silver:'linear-gradient(90deg,#fff,#d9d9d9,#fff)'
  };
  if(headline){
    headline.style.background = map[name] || map.pink;
    headline.style.webkitBackgroundClip='text';
    headline.style.webkitTextFillColor='transparent';
    headline.style.backgroundSize='200% auto';
    headline.style.animation='brilhoSuave 6s linear infinite';
  }
  localStorage.setItem('album_gradient', name);
}

/* TraduÃ§Ãµes dinÃ¢micas */
function setTexts(){
  const T = STR[Lang] || STR.pt;

  document.getElementById('speedLbl').textContent = T.speed;
  document.getElementById('fsSpeedLbl').textContent = T.speed;
  document.getElementById('themeLbl').textContent = T.theme;
  document.getElementById('gradLbl').textContent  = T.gradient;

  document.getElementById('fullscreen').textContent = T.fullscreen;
  document.getElementById('slideshow').textContent = timer ? T.stop : T.start;
  fsToggle.textContent = timer ? T.stop : T.start;

  // filtros traduzidos
  document.getElementById('fltAll').textContent    = T.all;
  document.getElementById('fltPhotos').textContent = T.photos;
  document.getElementById('fltVideos').textContent = T.videos;

  ph.textContent = T.choose;

  const by = `${T.by} ${(CONFIG&&CONFIG.author)||'Ruben Silva'} â€¢ ${(CONFIG&&CONFIG.projectName)||'LOCALBUM'}`
             + ((CONFIG&&CONFIG.donateURL)?` â€¢ ${T.donate}: ${CONFIG.donateURL}`:'');

  document.getElementById('footerLine').textContent = by;
}

/* OrdenaÃ§Ã£o de meses (PT/EN, sem acentos) */
function monthOrder(a, b) {
    const monthNames = [
        "janeiro","fevereiro","marco","abril","maio","junho",
        "julho","agosto","setembro","outubro","novembro","dezembro",
        "january","february","march","april","may","june",
        "july","august","september","october","november","december"
    ];

    const normalize = s =>
        s.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");

    const getMonthIndex = name => {
        const norm = normalize(name);
        for (let i = 0; i < monthNames.length; i++) {
            if (norm.includes(monthNames[i])) {
                return i % 12; // devolve 0â€“11
            }
        }
        return -1; // nÃ£o tem mÃªs no nome
    };

    // Ecografias sempre primeiro
    if (normalize(a) === "ecografias") return -1;
    if (normalize(b) === "ecografias") return 1;

    const ma = getMonthIndex(a);
    const mb = getMonthIndex(b);

    // Ambos tÃªm mÃªs â†’ ordenar por mÃªs
    if (ma !== -1 && mb !== -1) return ma - mb;

    // SÃ³ A tem mÃªs â†’ A vem antes
    if (ma !== -1) return -1;

    // SÃ³ B tem mÃªs â†’ B vem antes
    if (mb !== -1) return 1;

    // Nenhum tem mÃªs â†’ ordem alfabÃ©tica normal
    return a.localeCompare(b, "pt", { numeric: true });
}


/* FormataÃ§Ã£o de datas (pt-PT / en-GB) */
function fmtDate(iso){
  const p = iso.split('-');
  const d = new Date(p[0], p[1]-1, p[2]);
  if(isNaN(d)) return iso;

  if(Lang === 'pt'){
    return d.toLocaleDateString("pt-PT", {
      day:"2-digit",
      month:"long",
      year:"numeric"
    });
  }
  return d.toLocaleDateString("en-GB", {
    day:"2-digit",
    month:"long",
    year:"numeric"
  });
}

/* Idade */
function ageStr(iso){
  if(!BIRTHDATE) return '';
  const p=iso.split('-'); 
  const d=new Date(p[0],p[1]-1,p[2]); 
  if(isNaN(d)) return '';
  const bd=new Date(BIRTHDATE); 
  if(isNaN(bd) || d<bd) return '';

  let y = d.getFullYear() - bd.getFullYear();
  let m = d.getMonth() - bd.getMonth();
  if(d.getDate() < bd.getDate()) m--;
  if(m < 0){ y--; m += 12; }

if (Lang === 'pt') {
  if (y === 0 && m === 0) {
    const days = Math.floor((d - bd) / 86400000);
    return `${days} dia${days !== 1 ? 's' : ''}`;
  }

  if (y === 0) {
    return `${m} ${m === 1 ? 'mÃªs' : 'meses'}`;
  }

  if (m === 0) {
    return `${y} ano${y !== 1 ? 's' : ''}`;
  }

  return `${y} ano${y !== 1 ? 's' : ''} e ${m} ${m === 1 ? 'mÃªs' : 'meses'}`;
}

  if(y===0 && m===0){
    const days = Math.floor((d-bd)/86400000);
    return `${days} day${days!==1?'s':''}`;
  }
  if(y===0) return `${m} month${m!==1?'s':''}`;
  if(m===0) return `${y} year${y!==1?'s':''}`;
  return `${y} year${y!==1?'s':''} and ${m} month${m!==1?'s':''}`;
}


// --- ExtensÃµes de vÃ­deo alinhadas com z3.ps1 ---
const VIDEO_EXTS = [
    "mp4", "mov", "webm", "mkv", "avi", "mts", "m2ts", "3gp", "hevc"
];


/* match filtro (por extensÃ£o) */
function matchFilterByName(name, filter = currentFilter) {
    const ext = name.split('.').pop().toLowerCase();

    if (filter === "all") return true;
    if (filter === "photos") return !VIDEO_EXTS.includes(ext);
    if (filter === "videos") return VIDEO_EXTS.includes(ext);

    return true;
}

function ecoOrder(a, b) {
    const pa = parseInt(a.name.split(" - ")[0]) || 0;
    const pb = parseInt(b.name.split(" - ")[0]) || 0;

    if (pa !== pb) return pa - pb;

    return new Date(a.date) - new Date(b.date);
}



function buildFlat() {
    flatList = [];
    if (typeof manifest === 'undefined') return;

    Object.keys(manifest).sort((a, b) => a - b).forEach(y => {

        Object.keys(manifest[y]).sort(monthOrder).forEach(m => {

            let items = manifest[y][m].slice();

            if (m.toLowerCase() === "ecografias") {
                items.sort(ecoOrder);
            } else {
                items.sort((a, b) => new Date(a.date) - new Date(b.date));
            }

            items.forEach(it => {
                flatList.push({
                    year: y,
                    month: m,
                    name: it.name,
                    date: it.date,
                    src: it.path
                });
            });
        });
    });
}

/* --------- RenderizaÃ§Ã£o com filtro inteligente (A1) --------- */
/* Devolve lista de anos vÃ¡lidos conforme filtro */
function getFilteredYears(){
  const out = [];
  Object.keys(manifest).sort((a,b)=>a-b).forEach(y=>{
    const has = Object.keys(manifest[y]).some(m =>
      manifest[y][m].some(it => matchFilterByName(it.name, currentFilter))
    );
    if(has) out.push(y);
  });
  return out;
}


/* Render anos */
function renderYears(){
  yearsEl.innerHTML='';
  const validYears = getFilteredYears();  // anos com conteÃºdo no filtro atual
  const allYears   = Object.keys(manifest).sort((a,b)=>a-b);

  allYears.forEach(y=>{
    const btn=document.createElement('button');
    btn.textContent=y;

    const has = validYears.includes(y);
    if(!has){
      btn.disabled = true;
      btn.style.opacity = "0.35";
      btn.style.cursor = "not-allowed";
    } else {
      btn.onclick=()=>{
        currentYear=y;
        yearsEl.querySelectorAll('button').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        renderMonths(y);
      };
    }

    yearsEl.appendChild(btn);
  });

  // se o ano atual deixar de existir ou ficar invÃ¡lido â†’ reset
  if(currentYear && !validYears.includes(currentYear)){
    currentYear=null; currentMonth=null;
    monthsEl.innerHTML=''; thumbsEl.innerHTML='';
  }
}


/* Meses filtrados por ano */
function getFilteredMonths(y){
  const out = [];
  const allMonths = Object.keys(manifest[y] || {}).sort(monthOrder);

  allMonths.forEach(m=>{
    const has = (manifest[y][m] || []).some(it =>
      matchFilterByName(it.name, currentFilter)
    );
    if(has) out.push(m);
  });

  // manter 'Ecografias' em primeiro
  const idxEco = out.findIndex(mm=>mm.toLowerCase()==='ecografias');
  if(idxEco>-1){ out.splice(idxEco,1); out.unshift('Ecografias'); }

  return out;
}


/* Render meses */
function renderMonths(y){
    monthsEl.innerHTML='';

    // lista completa dos meses ordenados
    let allMonths   = Object.keys(manifest[y] || {}).sort(monthOrder);

    // se existir Ecografias â†’ mete no topo
    const idxEco = allMonths.findIndex(m => m.toLowerCase() === 'ecografias');
    if (idxEco > -1) {
        allMonths.splice(idxEco, 1);
        allMonths.unshift('Ecografias');
    }

    const validMonths = getFilteredMonths(y);

    allMonths.forEach(m => {
        const btn = document.createElement('button');
        btn.textContent = m.charAt(0).toUpperCase() + m.slice(1);

        const has = validMonths.includes(m);

        if (!has) {
            btn.disabled = true;
            btn.style.opacity = "0.35";
            btn.style.cursor = "not-allowed";
        } else {
            btn.onclick = () => {
                currentMonth = m;
                monthsEl.querySelectorAll('button').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                renderThumbs(y, m);
            };
        }

        monthsEl.appendChild(btn);
    });

    if(currentMonth && !validMonths.includes(currentMonth)){
        currentMonth=null;
        thumbsEl.innerHTML='';
    }
}

/* --------- Filtros UI --------- */
let currentFilter="all";
function setFilter(f){
  currentFilter=f;
  [fltAll,fltPhotos,fltVideos].forEach(b=>b.classList.remove('active'));
  ({all:fltAll,photos:fltPhotos,videos:fltVideos}[f]).classList.add('active');

  // Ao mudar filtro: re-renderiza anos e meses conforme disponibilidade
  renderYears();
  if(currentYear){ renderMonths(currentYear); }
  if(currentYear && currentMonth){ renderThumbs(currentYear,currentMonth); }
}
fltAll.onclick   = ()=>setFilter("all");
fltPhotos.onclick= ()=>setFilter("photos");
fltVideos.onclick= ()=>setFilter("videos");

function renderThumbs(y, m) {
    thumbsEl.innerHTML = "";

    let list = manifest[y][m].slice().filter(it =>
        matchFilterByName(it.name, currentFilter)
    );

    if (m.toLowerCase() === "ecografias") {
        list.sort(ecoOrder);

        let group = "";

        list.forEach(it => {
            const lbl = fmtDate(it.date);
            if (lbl !== group) {
                group = lbl;
                const sep = document.createElement("div");
                sep.textContent = "ğŸ“… " + lbl;
                sep.style = "margin:8px 0 4px;color:var(--accent);font-weight:600;";
                thumbsEl.appendChild(sep);
            }
            addThumbCard(y, m, it);
        });

        return;
    }

    list.sort((a, b) => new Date(a.date) - new Date(b.date));

    let current = "";
    let first = true;

    list.forEach(it => {
        if (it.date !== current) {
            if (!first) {
                const sep = document.createElement("div");
                sep.className = "day-separator";
                thumbsEl.appendChild(sep);
            }
            current = it.date;
        }

        addThumbCard(y, m, it);
        first = false;
    });
}


function addThumbCard(y, m, it) {
    const card = document.createElement('div');
    card.className = 'thumb';

    const ext = it.name.split('.').pop().toLowerCase();
    const isVideo = VIDEO_EXTS.includes(ext);

    const el = isVideo
        ? document.createElement('video')
        : document.createElement('img');

    el.src = it.path;

    if (el.tagName === 'IMG') {
        el.loading = 'lazy';
        el.decoding = 'async';
    } else if (el.tagName === 'VIDEO') {
        el.muted = true;
    }

    card.appendChild(el);

    if (isVideo) {
        const icon = document.createElement('div');
        icon.className = 'videoIcon';
        icon.textContent = 'ğŸ¬';
        card.appendChild(icon);
    }

    const d = document.createElement('div');
    d.className = 'date';
    d.textContent = fmtDate(it.date);
    card.appendChild(d);

    card.onclick = () => {
        const idx = flatList.findIndex(x =>
            x.year === y &&
            x.month === m &&
            x.name === it.name
        );
        if (idx > -1) show(idx);
    };

    thumbsEl.appendChild(card);
}



/* Lista do mÃªs atual respeitando o filtro (para slideshow/next/prev) */
function monthListFiltered(y,m){
  return flatList.filter(x =>
      x.year === y &&
      x.month === m &&
      matchFilterByName(x.name, currentFilter)
  );
}

/* --------- Viewer --------- */
function show(i){
  if(!flatList.length) return;
  if(i<0) i=flatList.length-1; if(i>=flatList.length) i=0; curIdx=i;
  const it=flatList[i];

  // Se o item nÃ£o passa no filtro atual, tenta avanÃ§ar para o prÃ³ximo vÃ¡lido do mÃªs
  if(!matchFilterByName(it.name)){
    const ml = monthListFiltered(it.year,it.month);
    if(ml.length){
      const idx = flatList.findIndex(x=>x.year===ml[0].year && x.month===ml[0].month && x.name===ml[0].name);
      if(idx>-1){ curIdx=idx; return show(idx); }
    }
    return; // nada para mostrar
  }

  // Ajusta ano/mÃªs selecionados na UI (se vier de "restauro")
  if(currentYear!==it.year){ currentYear=it.year; renderYears(); }
  if(currentMonth!==it.month){ 
    currentMonth=it.month; 
    renderMonths(currentYear); 
  }

  stage.querySelectorAll('img,video').forEach(n=>n.remove());
  if(ph) ph.style.display='none';

  const ext=it.name.split('.').pop().toLowerCase();
  const isVideo = VIDEO_EXTS.includes(ext);
  const el = isVideo ? document.createElement('video') : document.createElement('img');
  el.src=it.src;
  if(el.tagName==='VIDEO'){
    const wasRunning=!!timer; if(wasRunning) stopSS();
    el.controls=true; el.playsInline=true; el.preload="metadata"; el.muted=false; el.autoplay=true;
    el.onended=()=>{ if(wasRunning) startSS(); };
  }
  el.onload=()=>el.classList.add('visible');
  el.onloadeddata=()=>el.classList.add('visible');
  stage.appendChild(el);

  metaEl.style.display='block'; metaEl.textContent=fmtDate(it.date);
  const a=ageStr(it.date); ageEl.style.display=a?'block':'none'; ageEl.textContent=a?('ğŸ¼ '+a):'';

  const currentMonthList = monthListFiltered(it.year,it.month);
  const pos=currentMonthList.findIndex(x=>x.name===it.name)+1;
  counterEl.style.display='block'; counterEl.textContent = currentMonthList.length ? `${pos}/${currentMonthList.length}` : '';

  [...document.querySelectorAll('.thumb')].forEach(t=>t.classList.remove('active'));
const tsel=[...document.querySelectorAll('.thumb img,.thumb video')].find(e=>decodeURIComponent(e.src).endsWith(`/${it.name}`));
if(tsel) {
  const parent = tsel.parentElement;
  parent.classList.add('active');
  // Faz scroll suave atÃ© Ã  miniatura visÃ­vel
  parent.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'nearest' });
}


  // Preload vizinhos (do mÃªs filtrado)
  const preloadByItem=(item)=>{
    if(!item) return;
    const ext=item.name.split('.').pop().toLowerCase();
    if (VIDEO_EXTS.includes(ext)) {const v=document.createElement('video'); v.src=item.src; v.preload="metadata"; }
    else { const img=new Image(); img.src=item.src; }
  };
  if(currentMonthList.length){
    const pIdx = currentMonthList.findIndex(x=>x.name===it.name);
    preloadByItem(currentMonthList[(pIdx+1)%currentMonthList.length]);
    preloadByItem(currentMonthList[(pIdx-1+currentMonthList.length)%currentMonthList.length]);
  }

  // Guardar Ãºltimo estado
  localStorage.setItem('album_last_year', it.year);
  localStorage.setItem('album_last_month', it.month);
  localStorage.setItem('album_last_name', it.name);

  resetBar();
}

/* next/prev respeitam filtro E mÃªs atual */
function next(){
  const it = flatList[curIdx]; if(!it) return;
  const list = monthListFiltered(it.year,it.month);
  if(!list.length) return;
  const pos = list.findIndex(x=>x.name===it.name);
  const nxt = list[(pos+1)%list.length];
  const idx = flatList.findIndex(x=>x.year===nxt.year&&x.month===nxt.month&&x.name===nxt.name);
  if(idx>-1) show(idx);
}
function prev(){
  const it = flatList[curIdx]; if(!it) return;
  const list = monthListFiltered(it.year,it.month);
  if(!list.length) return;
  const pos = list.findIndex(x=>x.name===it.name);
  const prv = list[(pos-1+list.length)%list.length];
  const idx = flatList.findIndex(x=>x.year===prv.year&&x.month===prv.month&&x.name===prv.name);
  if(idx>-1) show(idx);
}

function resetBar(){ bar.style.transition='none'; bar.style.width='0%'; void bar.offsetWidth; if(timer){ bar.style.transition=`width ${slideMs}ms linear`; setTimeout(()=>bar.style.width='100%',20); } }
function startSS(){
  if(timer) return;
  slideMs = document.fullscreenElement ? (+fsSpeed.value||4000) : (+speedSel.value||4000);
  timer=setInterval(()=>{ next(); resetBar(); }, slideMs);
  const T=STR[Lang]||STR.pt;
  document.getElementById('slideshow').classList.add('active');
  document.getElementById('slideshow').textContent=T.stop; fsToggle.textContent=T.stop; resetBar();
}
function stopSS(){
  if(!timer) return; clearInterval(timer); timer=null; bar.style.width='0%';
  const T=STR[Lang]||STR.pt;
  document.getElementById('slideshow').classList.remove('active');
  document.getElementById('slideshow').textContent=T.start; fsToggle.textContent=T.start;
}
function toggleSS(){ timer?stopSS():startSS(); }
document.getElementById('slideshow').onclick=toggleSS;

/* Velocidade dinÃ¢mica (normal e fullscreen) */
function applyNewSpeed(){
  slideMs = document.fullscreenElement ? (+fsSpeed.value||4000) : (+speedSel.value||4000);
  if(timer){ clearInterval(timer); timer=setInterval(()=>{ next(); resetBar(); }, slideMs); }
  resetBar();
}
speedSel.onchange=applyNewSpeed; fsSpeed.onchange=applyNewSpeed;

/* Fullscreen + HUD que aparece quando mexe o rato */
document.getElementById('fullscreen').onclick=()=>{
  if(!document.fullscreenElement) document.documentElement.requestFullscreen();
  else document.exitFullscreen();
};
let hudTimer=null;
function showHud(){
  if(!document.fullscreenElement) return;
  fsHud.classList.add('show'); clearTimeout(hudTimer);
  hudTimer=setTimeout(()=>fsHud.classList.remove('show'), 1500);
}
document.addEventListener('fullscreenchange',()=>{
  const on = !!document.fullscreenElement;
  fsHud.style.display = on ? 'flex' : 'none';
  if(on) showHud();
});
document.addEventListener('mousemove',()=>{ document.body.classList.add('show-arrows'); showHud(); });
document.getElementById('fsExit').onclick=()=>{ if(document.fullscreenElement) document.exitFullscreen(); };
fsToggle.onclick=toggleSS;

/* NavegaÃ§Ã£o teclas + setas visÃ­veis */
document.getElementById('arrowLeft').onclick=prev;
document.getElementById('arrowRight').onclick=next;
let arrowTimer; 
document.addEventListener('mousemove',()=>{
  document.body.classList.add('show-arrows');
  clearTimeout(arrowTimer);
  arrowTimer=setTimeout(()=>{document.body.classList.remove('show-arrows');},1800);
});
document.addEventListener('keydown',e=>{
  if(e.key==='ArrowRight') next();
  else if(e.key==='ArrowLeft') prev();
  else if(e.key===' '){ e.preventDefault(); toggleSS(); }
  else if(e.key.toLowerCase()==='f'){ if(!document.fullscreenElement) document.documentElement.requestFullscreen(); else document.exitFullscreen(); }
  if(['ArrowLeft','ArrowRight'].includes(e.key)){ document.body.classList.add('show-arrows'); showHud(); }
});

/* ===== InicializaÃ§Ã£o ===== */
function init(){
  const name = (typeof CONFIG!=='undefined' && CONFIG.displayName) ? CONFIG.displayName : 'MemÃ³rias';
  const proj = (typeof CONFIG!=='undefined' && CONFIG.projectName) ? CONFIG.projectName : 'Offline Photo Album';
  document.getElementById('headline').textContent = name;
  document.getElementById('subtitle').textContent = proj;
// Mostra o tÃ­tulo completo como tooltip ao passar o rato
document.getElementById('headline').title = name;


  applyTheme(localStorage.getItem('album_theme') || (CONFIG&&CONFIG.theme) || 'dark');
  themeSel.onchange=e=>applyTheme(e.target.value);

  applyGradient(localStorage.getItem('album_gradient') || 'pink');
  grad.onchange=e=>applyGradient(e.target.value);

  saveTheme.onclick=()=>{ saveThemePref(); saveTheme.textContent='âœ…'; setTimeout(()=>saveTheme.textContent='ğŸ’¾',900); };

  langToggle.onclick=()=>{ 
    Lang=(Lang==='pt'?'en':'pt'); 
    localStorage.setItem('album_lang',Lang);
    langToggle.textContent=(Lang==='pt')?'ğŸ‡µğŸ‡¹ / ğŸ‡¬ğŸ‡§':'ğŸ‡¬ğŸ‡§ / ğŸ‡µğŸ‡¹'; 
    langToggle.title=(Lang==='pt')?'Mudar para inglÃªs':'Switch to Portuguese'; 
    setTexts(); 

    // Re-render para aplicar traduÃ§Ãµes e manter filtro
    renderYears();
    if(currentYear) renderMonths(currentYear);
    if(currentYear && currentMonth) renderThumbs(currentYear,currentMonth);
  };
  langToggle.textContent=(Lang==='pt')?'ğŸ‡µğŸ‡¹ / ğŸ‡¬ğŸ‡§':'ğŸ‡¬ğŸ‡§ / ğŸ‡µğŸ‡¹';
  langToggle.title=(Lang==='pt')?'Mudar para inglÃªs':'Switch to Portuguese';

  setTexts();

  if(typeof manifest==='undefined'){ stage.innerHTML='<div style="color:#bbb">Erro: manifest nÃ£o encontrado.</div>'; return; }

  buildFlat(); 
  renderYears();

  // Restaurar Ãºltimo estado
  const ly=localStorage.getItem('album_last_year');
  const lm=localStorage.getItem('album_last_month');
  const ln=localStorage.getItem('album_last_name');
  if(ly && lm && manifest[ly] && manifest[ly][lm]){
    // garantir que ano/mÃªs existem com filtro ATUAL
    currentFilter="all"; // no restauro inicial, mostrar tudo para garantir visibilidade
    [fltAll,fltPhotos,fltVideos].forEach(b=>b.classList.remove('active')); fltAll.classList.add('active');
    renderYears();
    [...yearsEl.querySelectorAll("button")].find(b=>b.textContent==ly)?.click();
    setTimeout(()=>{
      [...monthsEl.querySelectorAll("button")].find(b=>b.textContent.toLowerCase()==lm.toLowerCase())?.click();
      setTimeout(()=>{ const idx=flatList.findIndex(x=>x.name==ln && x.year==ly && x.month==lm); if(idx>=0) show(idx); },80);
    },80);
  }
}
init();

// Expor no global
window.renderYears=renderYears; window.buildFlat=buildFlat; window.init=init;
</script>
</body>
</html>
